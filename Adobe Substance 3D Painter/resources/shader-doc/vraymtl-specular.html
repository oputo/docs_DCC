<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>vraymtl-specular.glsl</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="cm">/*************************************************************************</span>
<span class="cm">* ADOBE CONFIDENTIAL</span>
<span class="cm">* ___________________</span>
<span class="cm">* Copyright 2020 Adobe</span>
<span class="cm">* All Rights Reserved.</span>
<span class="cm">* NOTICE:  All information contained herein is, and remains</span>
<span class="cm">* the property of Adobe and its suppliers, if any. The intellectual</span>
<span class="cm">* and technical concepts contained herein are proprietary to Adobe</span>
<span class="cm">* and its suppliers and are protected by all applicable intellectual</span>
<span class="cm">* property laws, including trade secret and copyright laws.</span>
<span class="cm">* Dissemination of this information or reproduction of this material</span>
<span class="cm">* is strictly forbidden unless prior written permission is obtained</span>
<span class="cm">* from Adobe.</span>
<span class="cm">*************************************************************************/</span>

<span class="c1">//********************************************************************</span>
<span class="c1">// V-Ray Shaders for Substance 3D Painter</span>
<span class="c1">// </span>
<span class="c1">// Copyright (c) 2020 Chaos Software Ltd</span>
<span class="c1">// </span>
<span class="c1">// Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1">// of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1">// in the Software without restriction, including without limitation the rights</span>
<span class="c1">// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1">// copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1">// furnished to do so, subject to the following conditions:</span>
<span class="c1">// </span>
<span class="c1">// The above copyright notice and this permission notice shall be included in all</span>
<span class="c1">// copies or substantial portions of the Software.</span>
<span class="c1">// </span>
<span class="c1">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1">// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1">// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1">// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1">// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1">// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1">// SOFTWARE.</span>
<span class="c1">//********************************************************************</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h1>Substance Painter VRayMtl shader</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Channels needed for diffuse/specular workflow are bound here.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="c1">//: param auto channel_diffuse</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">diffuse_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_glossiness</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">glossiness_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_specular</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">specular_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_transmissive</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">transmissive_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_emissive</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">emissive_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_anisotropyangle</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">anisotropyangle_tex</span><span class="p">;</span>
<span class="c1">//: param auto channel_anisotropylevel</span>
<span class="k">uniform</span><span class="w"> </span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">anisotropylevel_tex</span><span class="p">;</span>

<span class="n">import</span><span class="w"> </span><span class="n">lib</span><span class="o">-</span><span class="n">env</span><span class="p">.</span><span class="n">glsl</span>
<span class="n">import</span><span class="w"> </span><span class="n">lib</span><span class="o">-</span><span class="n">random</span><span class="p">.</span><span class="n">glsl</span>
<span class="n">import</span><span class="w"> </span><span class="n">lib</span><span class="o">-</span><span class="n">sampler</span><span class="p">.</span><span class="n">glsl</span>
<span class="n">import</span><span class="w"> </span><span class="n">lib</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">glsl</span>
<span class="n">import</span><span class="w"> </span><span class="n">lib</span><span class="o">-</span><span class="n">vectors</span><span class="p">.</span><span class="n">glsl</span>

<span class="c1">//: state cull_face off</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Parameters from Substance</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="c1">//: param auto main_light</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">vec4</span><span class="w"> </span><span class="n">uniform_main_light</span><span class="p">;</span>

<span class="c1">// params from lib-pbr.</span>
<span class="c1">// We don&#39;t want to import the entire lib-pbr because it brings lib-emissive</span>
<span class="c1">// and that messes with our self-illumination params</span>

<span class="c1">//: param auto environment_max_lod</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">maxLod</span><span class="p">;</span>

<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: 16,</span>
<span class="c1">//:   &quot;label&quot;: &quot;Quality&quot;,</span>
<span class="c1">//:   &quot;widget&quot;: &quot;combobox&quot;,</span>
<span class="c1">//:   &quot;values&quot;: {</span>
<span class="c1">//:     &quot;Very low (4 spp)&quot;: 4,</span>
<span class="c1">//:     &quot;Low (16 spp)&quot;: 16,</span>
<span class="c1">//:     &quot;Medium (32 spp)&quot;: 32,</span>
<span class="c1">//:     &quot;High (64 spp)&quot;: 64,</span>
<span class="c1">//:     &quot;Very high (128 spp)&quot;: 128,</span>
<span class="c1">//:     &quot;Ultra (256 spp)&quot;: 256</span>
<span class="c1">//:   },</span>
<span class="c1">//:   &quot;group&quot;: &quot;Common Parameters&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nbSamples</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>VRayMtl specific options</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="c1">// Group basic options</span>
<span class="c1">//: param custom { &quot;default&quot;: 1, &quot;label&quot;: &quot;Base color amount&quot;, &quot;min&quot;: 0, &quot;max&quot;: 1, &quot;group&quot;: &quot;Base color&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_diffuse_amount</span><span class="p">;</span>

<span class="c1">// Group reflection</span>
<span class="c1">//: param custom { &quot;default&quot;: 1, &quot;label&quot;: &quot;Reflection amount&quot;, &quot;min&quot;: 0, &quot;max&quot;: 1, &quot;group&quot;: &quot;Reflection&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_reflection_amount</span><span class="p">;</span>
<span class="c1">//: param custom { &quot;default&quot;: true, &quot;label&quot;: &quot;Use fresnel&quot;, &quot;group&quot;: &quot;Reflection&quot;, &quot;description&quot;: &quot;Make reflection strength dependent on the viewing angle (e.g. glass materials). Depends on IOR.&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">uniform_use_fresnel</span><span class="p">;</span>
<span class="c1">//: param custom { &quot;default&quot;: true, &quot;label&quot;: &quot;Lock fresnel IOR to refraction IOR&quot;, &quot;group&quot;: &quot;Reflection&quot;, &quot;description&quot;: &quot;Use the same IOR as refraction for reflection fresnel.&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">uniform_lock_fresnel_ior</span><span class="p">;</span>
<span class="c1">//: param custom { &quot;default&quot;: 1.6, &quot;label&quot;: &quot;Fresnel IOR&quot;, &quot;group&quot;: &quot;Reflection&quot;, &quot;description&quot;: &quot;Separate fresnel reflection IOR, when not locked to refraction IOR.&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_fresnel_ior</span><span class="p">;</span>

<span class="c1">// Group refraction</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: 1, &quot;label&quot;: &quot;Refraction amount&quot;, &quot;min&quot;: 0, &quot;max&quot;: 1, &quot;widget&quot;: &quot;color&quot;, &quot;group&quot;: &quot;Refraction&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_refraction_amount</span><span class="p">;</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: 1.6, &quot;label&quot;: &quot;IOR&quot;, &quot;group&quot;: &quot;Refraction&quot;,</span>
<span class="c1">//:   &quot;description&quot;: &quot;Index of refraction for refraction effect and fresnel reflections (unless disabled in Reflection options)&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_refraction_ior</span><span class="p">;</span>
<span class="c1">//: param custom { &quot;default&quot;: 1, &quot;label&quot;: &quot;Refraction glossiness&quot;, &quot;min&quot;: 0, &quot;max&quot;: 1, &quot;group&quot;: &quot;Refraction&quot;, &quot;description&quot;: &quot;Separate refraction glossiness&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_refraction_glossiness</span><span class="p">;</span>

<span class="c1">// Group BRDF</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: 3,</span>
<span class="c1">//:   &quot;label&quot;: &quot;BRDF type&quot;,</span>
<span class="c1">//:   &quot;widget&quot;: &quot;combobox&quot;,</span>
<span class="c1">//:   &quot;values&quot;: {</span>
<span class="c1">//:     &quot;Phong&quot;: 0,</span>
<span class="c1">//:     &quot;Blinn&quot;: 1,</span>
<span class="c1">//:     &quot;Ward&quot;: 2,</span>
<span class="c1">//:     &quot;GGX&quot;: 3</span>
<span class="c1">//:   },</span>
<span class="c1">//:   &quot;group&quot;: &quot;BRDF&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uniform_brdf_type</span><span class="p">;</span>
<span class="c1">//: param custom { &quot;default&quot;: 2, &quot;label&quot;: &quot;GGX tail falloff&quot;, &quot;min&quot;: 1, &quot;max&quot;: 10, &quot;group&quot;: &quot;BRDF&quot; }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">uniform_gtr_gamma</span><span class="p">;</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: 2,</span>
<span class="c1">//:   &quot;label&quot;: &quot;Anisotropy axis&quot;,</span>
<span class="c1">//:   &quot;widget&quot;: &quot;combobox&quot;,</span>
<span class="c1">//:   &quot;values&quot;: {</span>
<span class="c1">//:     &quot;X&quot;: 0,</span>
<span class="c1">//:     &quot;Y&quot;: 1,</span>
<span class="c1">//:     &quot;Z&quot;: 2</span>
<span class="c1">//:   },</span>
<span class="c1">//:   &quot;group&quot;: &quot;BRDF&quot;,</span>
<span class="c1">//:   &quot;description&quot;: &quot;Base local axis for anisotropic highlight&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uniform_anisotropy_axis</span><span class="p">;</span>

<span class="c1">// Group options</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: true, &quot;label&quot;: &quot;Trace reflections&quot;, &quot;group&quot;: &quot;Options&quot;,</span>
<span class="c1">//:   &quot;description&quot;: &quot;When disabled, reflections are not traced, resulting in only highlights. Also the diffuse color is not dimmed by the reflection color, as would happen normally&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">uniform_trace_reflections</span><span class="p">;</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: true, &quot;label&quot;: &quot;Trace refractions&quot;, &quot;group&quot;: &quot;Options&quot;,</span>
<span class="c1">//:   &quot;description&quot;: &quot;When disabled, refractions are not traced&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">uniform_trace_refractions</span><span class="p">;</span>
<span class="c1">//: param custom {</span>
<span class="c1">//:   &quot;default&quot;: false, &quot;label&quot;: &quot;Double sided&quot;, &quot;group&quot;: &quot;Options&quot;,</span>
<span class="c1">//:   &quot;description&quot;: &quot;When enabled, V-Ray also shades the back-facing surfaces. Otherwise, the lighting for the outer side is always computed. Can be used to achieve a fake translucent effect for thin objects like paper.&quot;</span>
<span class="c1">//: }</span>
<span class="k">uniform</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">uniform_double_sided</span><span class="p">;</span>


<span class="kt">float</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Functions from lib-pbr we need to sample the environment properly {{{</span>

<span class="c1">/// Compute the inverse of the solid angle of the differential pixel in the</span>
<span class="c1">/// cube map pointed at by Wn</span>
<span class="c1">/// @param Wn World-space direction</span>
<span class="kt">float</span><span class="w"> </span><span class="n">distortion</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">Wn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sinT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">Wn</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">Wn</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">sinT</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Get the LOD for sampling the environment</span>
<span class="c1">/// @param Wn World-space normal</span>
<span class="c1">/// @param p Probability of this direction (from sampleBRDF)</span>
<span class="c1">/// @param numSamples Total number of samples</span>
<span class="kt">float</span><span class="w"> </span><span class="n">computeLOD</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">Wn</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numSamples</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numSamples</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">maxLod</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log2</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">numSamples</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">distortion</span><span class="p">(</span><span class="n">Wn</span><span class="p">)));</span>
<span class="w">	</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// }}} End functions from lib-pbr</span>

<span class="k">struct</span><span class="w"> </span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">Vw</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">diffuseColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">diffuseAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">roughness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">selfIllum</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">reflColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reflAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">traceReflections</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">metalness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">aniso</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">anisoRotation</span><span class="p">;</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">anisoAxis</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">refractionColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">refractionAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">refrGloss</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">traceRefractions</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">refractionIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">useFresnel</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">fresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">lockFresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">doubleSided</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">useRoughness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">;</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">brdfType</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">approxEnv</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gloss1</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gloss2</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">e</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">diff</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">fresnel</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">reflNoFresnel</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">refl</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">refr</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">illum</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">rtermA</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">rtermB</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">blueNoise</span><span class="p">;</span><span class="w"> </span><span class="c1">// blue noise value based on fragment</span>
<span class="w">	</span><span class="kt">mat3</span><span class="w">  </span><span class="n">nm</span><span class="p">;</span>
<span class="w">	</span><span class="kt">mat3</span><span class="w">  </span><span class="n">inm</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">float</span><span class="w"> </span><span class="n">intensity</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w">  </span><span class="n">vraySampleBRDF</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">brdfContrib</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w">  </span><span class="n">vraySampleRefractBRDF</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">totalInternalReflection</span><span class="p">);</span>

<span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">initVRayMtlContext</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">initParams</span><span class="p">);</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeDirectDiffuseContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeDirectReflectionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectDiffuseContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectReflectionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectRefractionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">alphaDir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuseIndirect</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="n">debugOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span>

<span class="c1">// Output v as colour, suppress normal shading</span>
<span class="kt">void</span><span class="w"> </span><span class="n">vrayDebug</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="n">debugOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">	</span><span class="n">albedoOutput</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">	</span><span class="n">diffuseShadingOutput</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Output f as grey colour, suppress normal shading</span>
<span class="kt">void</span><span class="w"> </span><span class="n">vrayDebug</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="n">vrayDebug</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define PI 3.1415926535897932384626433832795</span>
<span class="cp">#define INV_PI (1.0/PI)</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayWhiteComplement</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">vrayComputeTangentVectors</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="c1">// It doesn&#39;t matter what these vectors are, the result vectors just need to be perpendicular to the normal and to each other</span>
<span class="w">	</span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.643782</span><span class="p">,</span><span class="w"> </span><span class="mf">0.98432</span><span class="p">,</span><span class="w"> </span><span class="mf">0.324632</span><span class="p">));</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="w">		</span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.432902</span><span class="p">,</span><span class="w"> </span><span class="mf">0.43223</span><span class="p">,</span><span class="w"> </span><span class="mf">0.908953</span><span class="p">));</span>
<span class="w">	</span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
<span class="w">	</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">vrayMakeNormalMatrix</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">mat3</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="n">vrayComputeTangentVectors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mo">0</span><span class="p">],</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetFresnelCoeff</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">fresnelIOR</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">refractDir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">fresnelIOR</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">refractDir</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosIn</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cosR</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// View direction is perpendicular to the surface</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">fresnelIOR</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">fresnelIOR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">ks</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cosR</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosIn</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">fs2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">Fs</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">fs2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fs2</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">kp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cosIn</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosR</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">fp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">kp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">Fp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">fp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fp2</span><span class="p">;</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Fs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetSpecularDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaSin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thetaSin</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">phi</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">,</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetPhongDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">glossiness</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">mat3</span><span class="w"> </span><span class="n">nm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">reflectDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">nm</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">s</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="n">reflectDir</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">s1</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">	</span><span class="kt">mat3</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mo">0</span><span class="p">]</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">sampleDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetSpecularDir</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="n">glossiness</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleDir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetBlinnDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">glossiness</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">mat3</span><span class="w"> </span><span class="n">nm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">nn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetSpecularDir</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="n">glossiness</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">h</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">nm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nn</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cs</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">view</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">view</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetSphereDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaSin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thetaSin</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">phi</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">,</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetWardDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">glossiness</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">mat3</span><span class="w"> </span><span class="n">nm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">		</span><span class="n">u</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">		</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">glossiness</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">));</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">hn</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetSphereDir</span><span class="p">(</span><span class="n">thetaCos</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">hw</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">nm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hn</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">dir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetGTR1MicroNormal</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">sharpness</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="mf">0.999</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">sharpness2</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">uc</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">thetaCosSqr</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaSin</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vc</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Specific implementation when gamma == 2. See section B.2 Physically-Based Shading at Disney from SIGGRAPH 2012</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetGTR2MicroNormal</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//vrayDebug(sharpness);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">uc</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">uc</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">thetaCosSqr</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaSin</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vc</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// // General implementation  when gamma != 1 and != 2. See section B.2 Physically-Based Shading at Disney from SIGGRAPH 2012</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetGTRMicroNormal</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">sharpness</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="mf">0.999</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">sharpness2</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">uc</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaCos</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">thetaCosSqr</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">thetaSin</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thetaCosSqr</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vc</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">thetaSin</span><span class="p">,</span><span class="w"> </span><span class="n">thetaCos</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetGGXMicroNormal</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTR1MicroNormal</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTR2MicroNormal</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="c1">// if (gtrLowerLimit &lt;= gtrGamma &amp;&amp; gtrGamma &lt;= gtrUpperLimit)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTRMicroNormal</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTR1MicrofacetDistribution</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">mz</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mz</span><span class="p">;</span><span class="w"> </span><span class="c1">// dotf(microNormal, normal);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cosThetaM</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">div</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">sharpness2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="p">);</span>
<span class="w">	</span><span class="c1">// when div&lt;(sharpness2-1.0f)*1e-6f no division by zero will occur (the dividend and the divisor are always negative);</span>
<span class="w">	</span><span class="c1">// div can get 0 in rare situation when the sharpness read from texture mapped in reflection glossines is 0</span>
<span class="w">	</span><span class="c1">// and cosThetaM is 1 (and consequently tanThetaM2 is 0);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">div</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTR2MicrofacetDistribution</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">mz</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mz</span><span class="p">;</span><span class="w"> </span><span class="c1">// dotf(microNormal, normal);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="n">f</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cosThetaM</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">div</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="p">));</span>
<span class="w">	</span><span class="c1">// when div&gt;sharpness2*1e-6f no division by zero will occur (the dividend and the divisor are always positive);</span>
<span class="w">	</span><span class="c1">// div canget0 in rare situation when the sharpness read from texture mapped in reflection glossines is 0</span>
<span class="w">	</span><span class="c1">// and cosThetaM is 1 (and consequently tanThetaM2 is 0);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">div</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMicrofacetDistribution</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">mz</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mz</span><span class="p">;</span><span class="w"> </span><span class="c1">// dotf(microNormal, normal);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosThetaM</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cosThetaM</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosThetaM2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">divisor</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">sharpness2</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">cosThetaM2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanThetaM2</span><span class="p">),</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">dividend</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="c1">// when fabsf(divisor)&gt;fabsf(dividend)*1e-6f no division by zero will occur</span>
<span class="w">	</span><span class="c1">// (the dividend and the divisor are always either both positive or both negative);</span>
<span class="w">	</span><span class="c1">// divisor canget0 in rare situation when the sharpness read from texture mapped in reflection glossines is 0</span>
<span class="w">	</span><span class="c1">// and cosThetaM is 1 (and consequently tanThetaM2 is 0);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">divisor</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">dividend</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dividend</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">divisor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGGXMicrofacetDistribution</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">cosNH</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTR1MicrofacetDistribution</span><span class="p">(</span><span class="n">cosNH</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTR2MicrofacetDistribution</span><span class="p">(</span><span class="n">cosNH</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="c1">// if (gtrLowerLimit &lt;= gtrGamma &amp;&amp; gtrGamma &lt;= gtrUpperLimit)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGTRMicrofacetDistribution</span><span class="p">(</span><span class="n">cosNH</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing0</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing1</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mf">0.999</span><span class="p">,</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">sharpness2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing3</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mf">0.999</span><span class="p">,</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing4</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mf">0.999</span><span class="p">,</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">sharpness</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mf">8.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sharpness4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">b3</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">b3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cotThetaV2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">5.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sharpness2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowingSpline</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numKnots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">knots</span><span class="p">[</span><span class="n">numKnots</span><span class="p">];</span>
<span class="w">	</span><span class="n">knots</span><span class="p">[</span><span class="mo">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing0</span><span class="p">(</span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="n">knots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing1</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="n">knots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing2</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="n">knots</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing3</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="n">knots</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing4</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">numKnots</span><span class="p">];</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">numKnots</span><span class="p">];</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">		</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="c1">// solve tridiagonal</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">		</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">		</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mo">0</span><span class="p">]</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// contstruct polynomials</span>
<span class="w">	</span><span class="kt">vec4</span><span class="w"> </span><span class="n">polys</span><span class="p">[</span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numKnots</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">6.0</span><span class="p">;</span>
<span class="w">		</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">		</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">6.0</span><span class="p">;</span>
<span class="w">		</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">knots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="c1">// eval</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">idx</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">gtrGamma</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">polys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">polys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">polys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">polys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGGXMonodirectionalShadowing</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosThetaV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosThetaV</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cosThetaV</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Note: technically this is a division, but since we are only interested in the sign, we can do multiplication</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// when direction is collinear to the normal there is no shadowing</span>
<span class="w">	</span><span class="c1">// moreover if this case is not handled a division by zero will happen on the next line</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosThetaV</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cotThetaV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cosThetaV</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vraySqr</span><span class="p">(</span><span class="n">cosThetaV</span><span class="p">));</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// when gamma is any of the integer values 0, 1, 2, 3, 4 apply analytical solution</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing0</span><span class="p">(</span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing1</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing2</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing3</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowing4</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="c1">// gamma is not an integer. interpolate</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGTRMonodirectionalShadowingSpline</span><span class="p">(</span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">cotThetaV</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGGXBidirectionalShadowingMasking</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">vrayGetGGXMonodirectionalShadowing</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vrayGetGGXMonodirectionalShadowing</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayGetGGXContribution</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">hl</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">partialProb</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cosON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">));</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosIN</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cosON</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">partialBrdf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">hn</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">hl</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">	</span><span class="n">D</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXMicrofacetDistribution</span><span class="p">(</span><span class="n">hn</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="w">	</span><span class="n">partialBrdf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vrayGetGGXBidirectionalShadowingMasking</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cosIN</span><span class="p">;</span><span class="w"> </span><span class="c1">// division by cosON is omitted because we would have to multiply by the same below;</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hn</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">partialProb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hn</span><span class="p">;</span>

<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">ho</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">);</span>
<span class="w">		</span><span class="n">partialProb</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ho</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ho</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="c1">// reduce some multiplications in the final version</span>
<span class="w">	</span><span class="c1">// partialBrdf *= cosON; - omitted</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">partialBrdf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayGetGGXDir</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="kt">mat3</span><span class="w"> </span><span class="n">nm</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">prob</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">brdfDivByProb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">microNormalLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXMicroNormal</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//vrayDebug(microNormalLocal * 0.5 + vec3(0.5));</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">microNormalLocal</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">nm</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">microNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">microNormalLocal</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// Compute and keep the length of the half-vector in local space; needed for anisotropy correction</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">microNormal</span><span class="p">,</span><span class="w"> </span><span class="n">microNormal</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">L</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">L2</span><span class="p">);</span>
<span class="w">	</span><span class="n">microNormal</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">L</span><span class="p">;</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">microNormal</span><span class="p">);</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">Dval</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">partialProb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">partialBrdf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXContribution</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">microNormal</span><span class="p">,</span><span class="w"> </span><span class="n">microNormalLocal</span><span class="p">,</span><span class="w"> </span><span class="n">sharpness</span><span class="p">,</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="n">nm</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">partialProb</span><span class="p">,</span><span class="w"> </span><span class="n">Dval</span><span class="p">);</span>
<span class="w">	</span><span class="n">partialProb</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">L2</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">// take anisotropy in consideration</span>
<span class="w">	</span><span class="n">prob</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Dval</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">partialProb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Dval</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="n">e18</span><span class="p">;</span><span class="w"> </span><span class="c1">// compute full probability</span>
<span class="w">	</span><span class="c1">// note: in the full VRayMtl prob is multiplied by 2PI, but in this shader</span>
<span class="w">	</span><span class="c1">// it&#39;s used exclusively to sample tne environment map, and we would have</span>
<span class="w">	</span><span class="c1">// to divide by 2PI in that computation.</span>
<span class="w">	</span><span class="n">brdfDivByProb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">partialProb</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">partialBrdf</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">partialProb</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">vrayRand</span><span class="p">(</span><span class="kt">vec2</span><span class="w"> </span><span class="n">co</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fract</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">co</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span><span class="mf">12.9898</span><span class="p">,</span><span class="w"> </span><span class="mf">78.233</span><span class="p">)))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">43758.5453</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// Generate a random vec2, u in (0, 1), v in (B, B+1) where B is a fragment-dependent random blue noise value.</span>
<span class="c1">/// The returned value is suitable to be used for sampling a specular BRDF. V is</span>
<span class="c1">/// offset using blue noise, so it can be above 1, but that should be OK because</span>
<span class="c1">/// it is expected to be used as the argument to a trigonometric function.</span>
<span class="kt">vec2</span><span class="w"> </span><span class="n">uvRand</span><span class="p">(</span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="c1">// plastic constant</span>
<span class="w">	</span><span class="c1">// gives slightly better result than golden ratio</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">plast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.324717957244746</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">invPlast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">plast</span><span class="p">;</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span>
<span class="w">			</span><span class="n">fract</span><span class="p">(</span><span class="kt">float</span><span class="p">(</span><span class="n">sampleIdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">invPlast</span><span class="p">),</span>
<span class="w">			</span><span class="kt">float</span><span class="p">(</span><span class="n">sampleIdx</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">nbSamples</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">blueNoise</span>
<span class="w">			</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">float</span><span class="w"> </span><span class="n">intensity</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vraySampleBRDF</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rayProb</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">brdfContrib</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">geomNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">brdfType</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">brdfType</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec2</span><span class="w">  </span><span class="n">uv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uvRand</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">dir</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="n">rayProb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="n">brdfContrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brdfType</span><span class="o">==</span><span class="mo">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Phong</span>
<span class="w">		</span><span class="n">dir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetPhongDir</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brdfType</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="c1">// Blinn</span>
<span class="w">		</span><span class="n">dir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetBlinnDir</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brdfType</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Ward</span>
<span class="w">		</span><span class="n">dir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetWardDir</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXDir</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gtrGamma</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">nm</span><span class="p">,</span><span class="w"> </span><span class="n">rayProb</span><span class="p">,</span><span class="w"> </span><span class="n">brdfContrib</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">brdfContrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vraySampleRefractBRDF</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">totalInternalReflection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">geomNormal</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">refractDir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">refract</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">refractionIOR</span><span class="p">);</span>
<span class="w">	</span><span class="n">totalInternalReflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">refractDir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">refractDir</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">		</span><span class="n">totalInternalReflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">s</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="n">refractDir</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">refractDir</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">	</span><span class="kt">mat3</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mo">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
<span class="w">	</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">refractDir</span><span class="p">);</span>

<span class="w">	</span><span class="kt">vec2</span><span class="w">  </span><span class="n">uv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uvRand</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">sampleIdx</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gloss</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">refrGloss</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mf">3.5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">sampleDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetSpecularDir</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">gloss</span><span class="p">);</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleDir</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">pow35</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">initVRayMtlContext</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">initParams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reflGloss</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflGloss</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">Vw</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">Vw</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">geomNormal</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">selfIllum</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">selfIllum</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">diffuseColor</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">diffuseColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">diffuseAmount</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">diffuseAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">reflColor</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reflAmount</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">traceReflections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">traceReflections</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">metalness</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">metalness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">aniso</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">aniso</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">anisoRotation</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">anisoRotation</span><span class="p">;</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">anisoAxis</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">anisoAxis</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">opacity</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">roughness</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">roughness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">refractionColor</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionColor</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">refractionAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionAmount</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">traceRefractions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">traceRefractions</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">refractionIOR</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">useFresnel</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">useFresnel</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">fresnelIOR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">fresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">lockFresnelIOR</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">lockFresnelIOR</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">doubleSided</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">doubleSided</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">useRoughness</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">useRoughness</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gtrGamma</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">gtrGamma</span><span class="p">;</span>
<span class="w">	</span><span class="kt">int</span><span class="w">   </span><span class="n">brdfType</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">brdfType</span><span class="p">;</span>

<span class="w">	</span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initParams</span><span class="p">.</span><span class="n">lockFresnelIOR</span><span class="p">)</span>
<span class="w">		</span><span class="n">fresnelIOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionIOR</span><span class="p">;</span>

<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">normalize</span><span class="p">(</span><span class="n">Vw</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">useRoughness</span><span class="p">)</span>
<span class="w">		</span><span class="n">reflGloss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">;</span><span class="w"> </span><span class="c1">// Invert glossiness (turn it into roughness)</span>

<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">reflGloss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">opacity</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">diff</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">diffuseColor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffuseAmount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">illum</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">selfIllum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="c1">// roughness</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sqrRough</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roughness</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roughness</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">rtermA</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sqrRough</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">sqrRough</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.33</span><span class="p">));</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">rtermB</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">0.45</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sqrRough</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">sqrRough</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.09</span><span class="p">));</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doubleSided</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">		</span><span class="n">geomNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">geomNormal</span><span class="p">;</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">reflectDir</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">geomNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// check for internal reflection</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">internalReflection</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">refractDir</span><span class="p">;</span>
<span class="w">	</span><span class="kt">bool</span><span class="w">  </span><span class="n">outToIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">ior</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">outToIn</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">refractionIOR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">refractionIOR</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">normal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">outToIn</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">geomNormal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">geomNormal</span><span class="p">);</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cost</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">sintSqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ior</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ior</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cost</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sintSqr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">internalReflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">		</span><span class="n">refractDir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">ior</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ior</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sintSqr</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normal</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">internalReflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">		</span><span class="n">refractDir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">reflectDir</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">useFresnel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">internalReflection</span><span class="p">)</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">vrayGetFresnelCoeff</span><span class="p">(</span><span class="n">fresnelIOR</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="n">refractDir</span><span class="p">),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="c1">//vrayDebug(result.fresnel);</span>

<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">reflNoFresnel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflColor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reflAmount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">opacity</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">refl</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">reflNoFresnel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// Reflection calculation including metalness. Taken from VRayMtl&#39;s original implementation.</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">metalColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">diff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">metalness</span><span class="p">;</span>

<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">dielectricReflectionTransparency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traceReflections</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">refl</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">reflectionTransparency</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">metalness</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dielectricReflectionTransparency</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">traceRefractions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">refr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refractionColor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">refractionAmount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">opacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reflectionTransparency</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">refr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">diff</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">reflectionTransparency</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">refr</span><span class="p">;</span>

<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">refl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mix</span><span class="p">(</span><span class="n">metalColor</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">refl</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">refl</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">fresnel</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">gloss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pow35</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span><span class="w"> </span><span class="c1">// [0, 1] -&gt; [0, inf)</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">gloss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">reflGloss</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">gloss2</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">gloss2</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtrGamma</span><span class="p">;</span>
<span class="w">	</span><span class="n">result</span><span class="p">.</span><span class="n">blueNoise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBlueNoiseThresholdTemporal</span><span class="p">();</span>

<span class="w">	</span><span class="c1">// Set up the normal/inverse normal matrices for BRDFs that support anisotropy</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">anisoDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anisoAxis</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mo">0</span><span class="p">)</span>
<span class="w">		</span><span class="n">anisoDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anisoAxis</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">		</span><span class="n">anisoDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">anisoAbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">aniso</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anisoAbs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">anisoAbs</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">vrayMakeNormalMatrix</span><span class="p">(</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">inm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transpose</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span><span class="w"> </span><span class="c1">// inverse = transpose for orthogonal matrix</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">internalReflection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">base0</span><span class="p">,</span><span class="w"> </span><span class="n">base1</span><span class="p">;</span>
<span class="w">		</span><span class="n">base0</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">anisoDirection</span><span class="p">));</span>
<span class="w">		</span><span class="n">base1</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">base0</span><span class="p">,</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">));</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">anisor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anisoRotation</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">6.2831853</span><span class="p">;</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">anisor</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">anisor</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">anisor</span><span class="p">);</span>
<span class="w">			</span><span class="kt">vec3</span><span class="w">  </span><span class="n">nu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">base1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<span class="w">			</span><span class="kt">vec3</span><span class="w">  </span><span class="n">nv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
<span class="w">			</span><span class="n">base0</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="p">;</span>
<span class="w">			</span><span class="n">base1</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">nv</span><span class="p">;</span>
<span class="w">		</span><span class="p">}</span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">base0</span><span class="p">,</span><span class="w"> </span><span class="n">base1</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="w">			</span><span class="n">vrayComputeTangentVectors</span><span class="p">(</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">base0</span><span class="p">,</span><span class="w"> </span><span class="n">base1</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aniso</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">aniso</span><span class="p">);</span>
<span class="w">			</span><span class="n">base0</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">			</span><span class="n">base1</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aniso</span><span class="p">);</span>
<span class="w">			</span><span class="n">base0</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">			</span><span class="n">base1</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">[</span><span class="mo">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base0</span><span class="p">;</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base1</span><span class="p">;</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geomNormal</span><span class="p">;</span>
<span class="w">		</span><span class="n">result</span><span class="p">.</span><span class="n">inm</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">inverse</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">nm</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlDiffuse</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">normal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlDiffuseRoughness</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">));</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">rmult</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">vecV</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">NV</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">vecV</span><span class="p">),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">theta_i</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">acos</span><span class="p">(</span><span class="n">lightNdotL</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">theta_r</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">acos</span><span class="p">(</span><span class="n">NV</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span><span class="w"> </span><span class="n">theta_r</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.571</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 1.571==pi/2</span>
<span class="w">		</span><span class="n">rmult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">beta</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span><span class="w"> </span><span class="n">theta_r</span><span class="p">);</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w">  </span><span class="n">vecVtan</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">vecV</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NV</span><span class="p">;</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w">  </span><span class="n">vecLtan</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">lightDir</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lightNdotL</span><span class="p">;</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">fMult</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">vecVtan</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">vecLtan</span><span class="p">);</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">cosDeltaPhi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fMult</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.000001</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">vecVtan</span><span class="p">,</span><span class="w"> </span><span class="n">vecLtan</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fMult</span><span class="p">;</span>
<span class="w">		</span><span class="n">rmult</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">rtermA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">rtermB</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">cosDeltaPhi</span><span class="p">));</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rmult</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlBlinn</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss1</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">hw</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">lightDir</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">hn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">inm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hw</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">			</span><span class="n">cs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">);</span>
<span class="w">		</span><span class="n">k</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">cs1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.125</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
<span class="w">		</span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">lightNdotL</span><span class="p">;</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlPhong</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">reflectDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cs1</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">reflectDir</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">			</span><span class="n">cs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">cs1</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"> </span><span class="c1">// phong k</span>
<span class="w">		</span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">lightNdotL</span><span class="p">;</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlWard</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cs1</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lightDir</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">;</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">hn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">inm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hw</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">tanhSqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">divd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">cs1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">;</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tanhSqr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">divd</span><span class="p">;</span>
<span class="w">			</span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">lightNdotL</span><span class="p">;</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">				</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayMtlGGX</span><span class="p">(</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">cs1</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lightNdotL</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cs1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">lightDir</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">);</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">hn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">inm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hw</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">D</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXMicrofacetDistribution</span><span class="p">(</span><span class="n">hn</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">G</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="n">vrayGetGGXBidirectionalShadowingMasking</span><span class="p">(</span><span class="o">-</span><span class="n">ctx</span><span class="p">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gloss2</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">gtrGamma</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">cs2</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">),</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">);</span>
<span class="w">			</span><span class="kt">vec3</span><span class="w">  </span><span class="n">micron</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">nm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hn</span><span class="p">;</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">L2</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">micron</span><span class="p">,</span><span class="w"> </span><span class="n">micron</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">anisotropyCorrection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">L2</span><span class="p">);</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">k</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">anisotropyCorrection</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cs1</span><span class="p">;</span><span class="w"> </span><span class="c1">// anisotropy correction</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">				</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeDirectDiffuseContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">roughness</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlDiffuse</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlDiffuseRoughness</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeDirectReflectionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">brdfType</span><span class="o">==</span><span class="mo">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlPhong</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">brdfType</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlBlinn</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">brdfType</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlWard</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">brdfType</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayMtlGGX</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectDiffuseContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="n">res</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">envIrradiance</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">geomNormal</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectReflectionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">.</span><span class="n">traceReflections</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">invNumSamples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">nbSamples</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">envSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nbSamples</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">brdfContrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">rayProb</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w">  </span><span class="n">dir</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">vraySampleBRDF</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">rayProb</span><span class="p">,</span><span class="w"> </span><span class="n">brdfContrib</span><span class="p">);</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brdfContrib</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="n">f</span><span class="p">)</span>
<span class="w">			</span><span class="k">continue</span><span class="p">;</span>
<span class="w">		</span><span class="kt">float</span><span class="w"> </span><span class="n">lod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeLOD</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">rayProb</span><span class="p">,</span><span class="w"> </span><span class="n">nbSamples</span><span class="p">);</span>
<span class="w">		</span><span class="n">envSum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSampleLOD</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">lod</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">brdfContrib</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">invNumSamples</span><span class="p">;</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">vec3</span><span class="w"> </span><span class="n">vrayComputeIndirectRefractionContribution</span><span class="p">(</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">alphaDir</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuseIndirect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">.</span><span class="n">traceRefractions</span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>

<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">invNumSamples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">nbSamples</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w">  </span><span class="n">view</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">params</span><span class="p">.</span><span class="n">Vw</span><span class="p">;</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.999</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSampleLOD</span><span class="p">(</span><span class="n">alphaDir</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="kt">vec3</span><span class="w"> </span><span class="n">envSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nbSamples</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			</span><span class="kt">bool</span><span class="w"> </span><span class="n">totalInternalReflection</span><span class="p">;</span>
<span class="w">			</span><span class="kt">vec3</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vraySampleRefractBRDF</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">totalInternalReflection</span><span class="p">);</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalInternalReflection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">				</span><span class="n">envSum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSampleLOD</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">				</span><span class="n">envSum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSampleLOD</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">			</span><span class="p">}</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">		</span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">envSum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">invNumSamples</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Sample texture and blend with default color where no data exists.</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">samplerSparse</span><span class="p">,</span><span class="w"> </span><span class="n">SparseCoord</span><span class="w"> </span><span class="n">coord</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">defaultColor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec4</span><span class="w"> </span><span class="n">sampledColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureSparse</span><span class="p">(</span><span class="n">samplerSparse</span><span class="p">,</span><span class="w"> </span><span class="n">coord</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">sampledColor</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sampledColor</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">defaultColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Sample texture and blend with default value, treating green as alpha.</span>
<span class="kt">float</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">SamplerSparse</span><span class="w"> </span><span class="n">samplerSparse</span><span class="p">,</span><span class="w"> </span><span class="n">SparseCoord</span><span class="w"> </span><span class="n">coord</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="kt">vec4</span><span class="w"> </span><span class="n">sampledValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureSparse</span><span class="p">(</span><span class="n">samplerSparse</span><span class="p">,</span><span class="w"> </span><span class="n">coord</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">sampledValue</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sampledValue</span><span class="p">.</span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Implemented in specular/metallic</span>
<span class="c1">/// initParams will be set up with geometry data prior to this call</span>
<span class="kt">void</span><span class="w"> </span><span class="n">setupInitParams</span><span class="p">(</span><span class="k">inout</span><span class="w"> </span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">SparseCoord</span><span class="w"> </span><span class="n">texCoord</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Shader entry point.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kt">void</span><span class="w"> </span><span class="n">shade</span><span class="p">(</span><span class="n">V2F</span><span class="w"> </span><span class="n">inputs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="c1">// Normal with bump/normal map applied</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">bumpNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeWSNormal</span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="n">sparse_coord</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">tangent</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">bitangent</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>

<span class="w">	</span><span class="c1">// Init VRayMtl</span>
<span class="w">	</span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">initParams</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// setup geometric data</span>
<span class="w">	</span><span class="c1">// for 2D put view vector along normal (see lib-vectors)</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">Vw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is2DView</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">bumpNormal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">getEyeVec</span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">geomNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bumpNormal</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">approxEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">	</span><span class="c1">// setup common parameters</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">diffuseAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_diffuse_amount</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">reflAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_reflection_amount</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">traceReflections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_trace_reflections</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">aniso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">anisoRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">anisoAxis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_anisotropy_axis</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_refraction_amount</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionIOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_refraction_ior</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">refrGloss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_refraction_glossiness</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">traceRefractions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_trace_refractions</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">useFresnel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_use_fresnel</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">fresnelIOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_fresnel_ior</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">lockFresnelIOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_lock_fresnel_ior</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">doubleSided</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_double_sided</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">useRoughness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">gtrGamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_gtr_gamma</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">brdfType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_brdf_type</span><span class="p">;</span>
<span class="w">	</span><span class="n">initParams</span><span class="p">.</span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">	</span><span class="c1">// flavour-specific setup</span>
<span class="w">	</span><span class="n">setupInitParams</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">sparse_coord</span><span class="p">);</span>

<span class="w">	</span><span class="c1">// Get detail (ambient occlusion) and global (shadow) occlusion factors</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">occlusion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAO</span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="n">sparse_coord</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">getShadowFactor</span><span class="p">();</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">specOcclusion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specularOcclusionCorrection</span><span class="p">(</span><span class="n">occlusion</span><span class="p">,</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">metalness</span><span class="p">,</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">useRoughness</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflGloss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflGloss</span><span class="p">);</span>

<span class="w">	</span><span class="c1">// Init context and sample material</span>
<span class="w">	</span><span class="n">VRayMtlContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initVRayMtlContext</span><span class="p">(</span><span class="n">initParams</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">lightDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniform_main_light</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">uniform_main_light</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuseDirect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayComputeDirectDiffuseContribution</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuseIndirect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vrayComputeIndirectDiffuseContribution</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffuseDirect</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">diffuseIndirect</span><span class="p">;</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">reflection</span><span class="w"> </span><span class="o">=</span>
<span class="w">			</span><span class="n">vrayComputeDirectReflectionContribution</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">lightDir</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">			</span><span class="n">vrayComputeIndirectReflectionContribution</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intensity</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">opacity</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">refraction</span><span class="w"> </span><span class="o">=</span>
<span class="w">		</span><span class="n">vrayComputeIndirectRefractionContribution</span><span class="p">(</span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">initParams</span><span class="p">.</span><span class="n">Vw</span><span class="p">,</span><span class="w"> </span><span class="n">diffuseIndirect</span><span class="p">);</span>

<span class="w">	</span><span class="c1">// Output values</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">debugOutput</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mo">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">albedoOutput</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">diff</span><span class="p">);</span>
<span class="w">		</span><span class="n">diffuseShadingOutput</span><span class="p">(</span><span class="n">occlusion</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffuse</span><span class="p">);</span>
<span class="w">		</span><span class="n">specularShadingOutput</span><span class="p">(</span><span class="n">specOcclusion</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reflection</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">refl</span><span class="p">);</span>
<span class="w">		</span><span class="c1">// output refraction with emissive as it can&#39;t really go elsewhere</span>
<span class="w">		</span><span class="n">emissiveColorOutput</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">illum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">refraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">refr</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="n">setupInitParams</span><span class="p">(</span><span class="k">inout</span><span class="w"> </span><span class="n">VRayMtlInitParams</span><span class="w"> </span><span class="n">initParams</span><span class="p">,</span><span class="w"> </span><span class="n">SparseCoord</span><span class="w"> </span><span class="n">texCoord</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="c1">// Fetch material parameters</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">diffuseColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">diffuse_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
<span class="w">    </span><span class="kt">vec3</span><span class="w"> </span><span class="n">specularColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">specular_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">glossiness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">glossiness_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">	</span><span class="kt">vec3</span><span class="w"> </span><span class="n">refractionColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">transmissive_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
<span class="w">    </span><span class="kt">vec3</span><span class="w"> </span><span class="n">selfIllumColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">emissive_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">anisotropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">anisotropylevel_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">anisotropyAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureWithDefault</span><span class="p">(</span><span class="n">anisotropyangle_tex</span><span class="p">,</span><span class="w"> </span><span class="n">texCoord</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">diffuseColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffuseColor</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">roughness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">glossiness</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">selfIllum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selfIllumColor</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specularColor</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">reflGloss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glossiness</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">refractionColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refractionColor</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">metalness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">aniso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anisotropy</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">anisoRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anisotropyAngle</span><span class="p">;</span>
<span class="w">    </span><span class="n">initParams</span><span class="p">.</span><span class="n">useRoughness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>

